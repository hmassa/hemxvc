<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <title>Welcome!</title>

        <link href="final_proj.css" rel="stylesheet" type="text/css">
        <script src="jquery-3.5.1.min.js"></script>
        
        <script>
            // https://github.com/spotify/web-api-auth-examples/blob/master/implicit_grant/public/index.html
            $(document).ready(function() {
                function getHashParams() {
                    var hashParams = {};
                    var e, r = /([^&;=]+)=?([^&;]*)/g, 
                        q = window.location.hash.substring(1);
                    while ( e = r.exec(q)) {
                        hashParams[e[1]] = decodeURIComponent(e[2]);
                    }

                    return hashParams;
                }
                
                function displayTracks(id, data){
                    var number = data.items.length;
                    for (i = 0; i < number; i++) {
                        var track = data.items[i];
                        $("#"+id).append('<div class="holder"><img class="photo" src=' + track.album.images[0].url + '><p class="primary">' + track.name + '</p><p class="secondary">' + track.album.name + '</p></div>');
                    }
                    
                }
                
                function displayArtists(id, data){
                    var number = data.items.length;
                    for (i = 0; i < number; i++) {
                        var artist = data.items[i];
                        $("#"+id).append('<div class="holder"><img class="photo" src=' + artist.images[0].url + '><p class="primary">' + artist.name + '</p><p class="secondary">' + artist.followers.total + ' followers</p></div>');
                    }
                    
                }
                
                var stateKey = 'spotify_auth_state';
                
                var params = getHashParams();
                var access_token = params.access_token,
                    state = params.state,
                    storedState = localStorage.getItem(stateKey);
                        
                if (access_token && (state == null || state !== storedState)) {
                    window.location = 'http://ec2-3-134-97-105.us-east-2.compute.amazonaws.com/finalproject';
                    alert('There was an error during the authentication. Please try again later.');
                } else {
                  //localStorage.removeItem(stateKey);
                    if (access_token) {
                        // ger user's account info
                        $.ajax({
                            url: 'https://api.spotify.com/v1/me',
                            type: 'GET',
                            headers: {
                              'Authorization': 'Bearer ' + access_token
                            },
                            success: function(response) {
                                $("#welcome").html('Welcome, ' + response.display_name + '! Check out the information we\'ve gathered from your listening history, playlists, and favorite artists.'); 
                            }
                        });
                        
                        // get all-time top tracks
                        $.ajax({
                            url: 'https://api.spotify.com/v1/me/top/tracks?time_range=long_term&limit=10',
                            type: 'GET',
                            headers: {
                              'Authorization': 'Bearer ' + access_token
                            },
                            success: function(response) {
                                displayTracks('all-tracks', response);
                            }
                        });
                        
                        //get all-time top artists
                        $.ajax({
                            url: 'https://api.spotify.com/v1/me/top/artists?time_range=long_term&limit=10',
                            type: 'GET',
                            headers: {
                              'Authorization': 'Bearer ' + access_token
                            },
                            success: function(response) {
                                displayArtists('all-artists', response);
                            }
                        });
                        
                        // get this months top tracks
                        $.ajax({
                            url: 'https://api.spotify.com/v1/me/top/tracks?time_range=short_term&limit=10',
                            type: 'GET',
                            headers: {
                              'Authorization': 'Bearer ' + access_token
                            },
                            success: function(response) {
                                displayTracks('month-tracks', response);
                            }
                        });
                        
                        // get this months top artists
                        $.ajax({
                            url: 'https://api.spotify.com/v1/me/top/artists?time_range=short_term&limit=10',
                            type: 'GET',
                            headers: {
                              'Authorization': 'Bearer ' + access_token
                            },
                            success: function(response) {
                                displayArtists('month-artists', response);
                            }
                        });
                        
                    } else {
                        window.location = 'http://ec2-3-134-97-105.us-east-2.compute.amazonaws.com/finalproject';
                    }
                }
                
            });
        </script>
    </head>

    <body class="gray-background">
        <div id="dashboard-background">
            <h1>Your Dashboard</h1>
            <p id="welcome"></p>
            <div>
                <h3>Your all-time top tracks</h3>
                <div class="showcase" id="all-tracks"></div>
                <h3>Your all-time top artists</h3>
                <div class="showcase" id="all-artists"></div>
                <h3>Your top tracks this month</h3>
                <div class="showcase" id="month-tracks"></div>
                <h3>Your top artists this month</h3>
                <div class="showcase" id="month-artists"></div>
            </div>
        </div>
    </body>
</html>
    